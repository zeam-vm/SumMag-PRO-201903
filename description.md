# はじめに

Cisco\cite{Cisco2018}によると，インターネット全体のIPトラフィックは，2017年に毎月122エクサバイト増加している．この増加率は年々増大しており，2022年には毎月396エクサバイト増加すると見込んでいる．また，IDC\cite{IDC2014}によると，インターネット上のデータの総量は2013年に4.4ゼタバイトであるが，2020年には44ゼタバイトに増加すると見込まれている．これらが示すように世界に流通する情報量は急速に増大している．

この問題に対処するためには，情報を処理する計算能力を情報量の流通量と同等以上に高める必要がある．しかし，Hennesy と Patterson \cite{HenessyPatterson2017}によると，2003年までは年々順調にクロック周波数が増加していたのに対し，2003年ごろから頭打ちとなってしまっている．これはクロック周波数が増大すると消費電力と発熱量も増大するが，電源供給量と熱伝導率および冷却能力が追いつかなくなり，常温の環境下で安定して動作させることが不可能になってしまうためである．

2003年以降のプロセッサの進化はクロック周波数の増加ではなくコア数の増加によっている．Intelが2006年に販売した Core シリーズの最上位プロセッサである Intel Core 2 Extreme X6800 は，クロック周波数が2.93GHz，物理コア数は2，論理コア数は4である．一方，2017年に販売した Core シリーズの最上位プロセッサである Intel Core i9 7980XE は，クロック周波数が2.6GHz，物理コア数は18，論理コア数は36である．

クロック数が順調に伸びていた時代ではソフトウェアを何も変えなくても順調に性能が向上していたであろう．一方，クロック周波数が伸びずにコア数が増加する状況下で性能を向上させるためには，並列プログラミングが求められる．そこで，近年次々と，さまざまな並列プログラミングモデルに基づいたプログラミング言語が提案されている．

Elixir(エリクサー)\cite{Elixir}は2012年にJos\'{e} Valimが開発した並列プログラミング言語である．Elixirは関数型言語Erlang\cite{Erlang}を母体としており，並列プログラミングのための数々の優れた特長を有する．

Elixirを用いることで，たとえばウェブシステムのレスポンス性能を大きく改善することができる．Fedrecheskiら\cite{Elixir16}によると，Javaでは毎秒1,200リクエスト程度で急速にレスポンス性能が悪化してしまったのに対し，Elixirでは毎秒1,800リクエスト程度まで耐えられる．

このような背景で我々は Hastega (ヘイスガ)のプロトタイプを開発した\cite{ZACKY18J, Hisae19J, ZACKY19-Hastega, ZACKY19-Hastega-Medium, ZEAM-log}．Hastega は，ウェブアプリケーションの中で行う画像処理や機械学習などの計算負荷の高い処理を，Elixirで簡潔に記述し，サーバー上やエッジ，ウェブクライアント上の CPU や GPU に負荷分散させながら高速に並列実行させることを目指している\cite{ZACKY19-Hastega, ZACKY19-Hastega-Medium}．

整数演算を行うベンチマークでは，Hastegaのプロトタイプは，元のElixirコードの4-8倍の速度向上，Python\cite{Python}のCuPy\cite{CuPy}を用いてGPUを駆動したコードの3倍以上の速度向上を得られた\cite{ZACKY18J}．線形回帰を行うベンチマークでは，Hastegaのプロトタイプは，元のElixirコードの5-17倍，インライン展開したElixirコードの4-8倍の速度向上が得られた\cite{Hisae19J}．この線形回帰のベンチマークでは，データの流量が増大すると並列化のためのコストの元が取れて速度向上比が大きくなる様子が観測されたことと，データ転送に時間がかかることと，分配アルゴリズムがコアに線形に展開するアルゴリズムであることから，分配するコア数が増えると極端に性能が悪化する様子が観測された\cite{Hisae19J}．

Hastega を本格的に実装するにあたり，(1)Elixirで書かれたコード中のパイプライン演算子とmap関数を用いた記述部分を抽出する部分と，(2)抽出したコードを並列化・最適化したネイティブコードにコンパイラする部分の，2つの構成要素に分割する設計方針を採用した．本報告で提案・報告する SumMag (サムマグ)は，前者(1)を Elixir マクロを用いて実装したメタプログラミングライブラリである．

Elixir は，リストとタプルからなる抽象構文木(AST)を操作するようなメタプログラミング機構，Elixir
マクロを提供している．そこで我々は，SumMag の実装にElixir マクロを用いた．

原理としてはパイプライン化された1つ以上の map 関数の適用をまとめて抽出して関数として分離し，元の Elixir コードの該当部分を抽出した関数への呼び出しに置き換える．このときに
map関数で適用される関数を Elixir コードのレベルでインライン展開し，かつ
map-mapフュージョンを行う．

本報告のこの後の構成は次のとおりである: 